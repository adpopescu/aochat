#!/usr/bin/python
# -*- coding: utf-8 -*-


"""
Anarchy Online chat.
"""


import sys

from aochat import Chat, ChatError
from aochat.dimensions import DIMENSIONS
from aochat.data import load_texts


### LAUNCHER ###################################################################


def load_config(filename):
    """
    Load configuration from file.
    """
    
    return {
        "general": {
            "username": "",
            "password": "",
            
            "dimension": 0,
            
            "timeout": 10,
        },
        
        "path": {
            "texts": "/var/lib/aochat/texts.dat",
        },
    }


def show_help():
    """
    Print help message.
    """
    
    # TODO: ...
    
    return 0


def show_error(error):
    """
    Print error message.
    """
    
    print >> sys.stderr, str(error).capitalize()
    
    return 1


def main(argv = []):
    """
    Launcher.
    """
    
    # Load settings
    config = load_config("/usr/local/etc/aochat.conf")
    
    # Prepare data
    load_texts(config["path"]["texts"])
    
    try:
        # Choose dimension
        if not 0 <= config["general"]["dimension"] <= len(DIMENSIONS):
            for i in range(len(DIMENSIONS)):
                print "%d - %s" % (i + 1, DIMENSIONS[i].name)
            
            while True:
                try:
                    choose = int(raw_input("Select dimension [1 to %d, 0 for exit]: " % len(DIMENSIONS)))
                    
                    if 1 <= choose <= len(DIMENSIONS):
                        dimension = DIMENSIONS[choose - 1]
                        break
                    elif choose == 0:
                        return 0
                except ValueError:
                    continue
        
        # Connect
        chat = Chat(
            username = config["general"]["username"],
            password = config["general"]["password"],
            
            host = dimension.host,
            port = dimension.port,
            
            timeout = config["general"]["timeout"],
        )
        
        # Choose character
        for i in range(len(chat.characters)):
            print "%d - %s" % (i + 1, chat.characters[i].name)
        
        while True:
            try:
                choose = int(raw_input("Select character [1 to %d, 0 for exit]: " % len(chat.characters)))
                
                if 1 <= choose <= len(chat.characters):
                    character = chat.characters[choose - 1]
                    break
                elif choose == 0:
                    return 0
            except ValueError:
                continue
        
        # Login
        chat.login(character.id)
        
        # Start chat
        chat.start({
            # Dummy
        })
    except ChatError, error:
        return show_error(error)
    
    return 0


if __name__ == "__main__":
    status = main(sys.argv[1:])
    sys.exit(status)
